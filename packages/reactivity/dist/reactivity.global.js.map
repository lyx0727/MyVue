{
  "version": 3,
  "sources": ["../src/index.ts", "../../shared/src/index.ts", "../src/effect.ts", "../src/reactive.ts"],
  "sourcesContent": ["export {reactive} from './reactive';\r\nexport {effect} from './effect';", "export const isObject = (value: any)=>{\r\n    return value !== null && typeof value === \"object\";\r\n}", "// current 'effect'\r\nexport let activeEffect:any = undefined;\r\n\r\nfunction cleanupEffect(effect:any){\r\n    const {deps} = effect;\r\n    for(let i = 0; i < deps.length; i++){\r\n        deps[i].delete(effect);\r\n    }\r\n    effect.deps.length = 0;\r\n}\r\n\r\nclass ReactiveEffect{\r\n    public active = true;\r\n    public parent = null;\r\n    public deps = [];\r\n    constructor(public fn:Function) {}\r\n    \r\n    run(){\r\n        if(!this.active){\r\n            return this.fn();\r\n        }\r\n        try{\r\n            \r\n            // in case be invoked by another 'effect'\r\n            // stack push\r\n            this.parent = activeEffect;\r\n            // set current 'effect'\r\n            activeEffect = this;\r\n            // clean \r\n            cleanupEffect(this);\r\n            return this.fn();\r\n        }\r\n        finally{\r\n            // stack pop\r\n            activeEffect = this.parent;\r\n        }\r\n    }\r\n\r\n    stop(){\r\n        if(this.active){\r\n            this.active = false;\r\n            cleanupEffect(this);\r\n        }\r\n    }\r\n}\r\n\r\nexport function effect(fn:Function){\r\n    const _effect = new ReactiveEffect(fn);\r\n    _effect.run();\r\n\r\n    // bind this\r\n    const runner:any = _effect.run.bind(_effect);\r\n    // mount 'effect' on 'runner'\r\n    runner.effect = _effect;\r\n    return runner;\r\n}\r\n\r\nconst targetMap = new WeakMap();\r\nexport function track(target:any, type:string, key:string|symbol){\r\n    if(!activeEffect) return;\r\n    let depsMap = targetMap.get(target);\r\n    if(!depsMap){\r\n        targetMap.set(target, (depsMap = new Map()));\r\n    }\r\n    let dep = depsMap.get(key);\r\n    if(!dep){\r\n        depsMap.set(key, (dep = new Set()));\r\n    }\r\n    let shouldTrack = !dep.has(activeEffect);\r\n    if(shouldTrack){\r\n        // bidirectional map\r\n        dep.add(activeEffect);\r\n        activeEffect.deps.push(dep);\r\n    }\r\n}\r\n\r\nexport function trigger(target:any, type:string, key:string|symbol, value:any, oldValue:any){\r\n    const depsMap = targetMap.get(target);\r\n    if(!depsMap) return;\r\n\r\n    let effects = depsMap.get(key);\r\n\r\n    if(effects){\r\n        // copy to avoid infinite loop\r\n        effects = new Set(effects);\r\n        effects.forEach((effect:any) => {\r\n            // acoid self-recursion\r\n            if(effect !== activeEffect){\r\n                effect.run();\r\n            }\r\n        });\r\n    }\r\n}", "import { isObject } from \"@vue/shared\";\r\nimport { track } from \"./effect\";\r\nimport { trigger } from \"./effect\";\r\n\r\n// record object which has had proxy\r\nconst reactiveMap = new WeakMap();\r\n\r\nconst enum ReactiveFlags {\r\n    IS_REACTIVE = '__v_isReactive'\r\n};\r\n\r\nexport function reactive(target: any){\r\n    // only for Object-type\r\n    if(!isObject(target)){  \r\n        return target;\r\n    }\r\n\r\n    // can have exactly ONE proxy\r\n    const exisitingProxy = reactiveMap.get(target);\r\n    if(exisitingProxy){\r\n        return exisitingProxy;\r\n    }\r\n\r\n    // 'target' has been a proxy\r\n    if(target[ReactiveFlags.IS_REACTIVE]){\r\n        return target;\r\n    }\r\n\r\n    const proxy = new Proxy(target, {\r\n        get(target, key, receiver){\r\n            if(key === ReactiveFlags.IS_REACTIVE){\r\n                return true;\r\n            }\r\n\r\n            track(target, 'get', key);\r\n\r\n            // receiver: proxy\r\n            // change 'this' from 'target' to 'proxy'\r\n            // in case 'get' a attribute which invoke 'get' again\r\n            return Reflect.get(target, key, receiver);\r\n        },\r\n        set(target, key, value, receiver){\r\n            let oldValue = target[key];\r\n            let result = Reflect.set(target, key, value, receiver);\r\n            \r\n            // changed\r\n            if(oldValue !== value){\r\n                trigger(target, 'set', key, value, oldValue);\r\n            }\r\n\r\n            return result;\r\n        }\r\n    })\r\n    // record\r\n    reactiveMap.set(target, proxy);\r\n    return proxy;\r\n}"],
  "mappings": "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",
  "names": []
}
